<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml" 
      xmlns:sec="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title th:text="${organization.name}">Organization</title>
</head>

<body>
    <div layout:fragment="content">
        <!-- Success Message -->
        <div th:if="${mainSuccess}" class="toast-container" style="position: fixed; top: 5rem; right: 1rem; z-index: 1050;">
            <div class="toast show" role="alert">
                <div class="toast-body bg-success text-white">
                    <i class="fas fa-check-circle"></i>
                    <span th:text="${mainSuccess}"></span>
                </div>
            </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title" th:text="${organization.name}">Organization Name</h1>
                <p class="page-description">Edit profile, attributes, and associated accounts.</p>
            </div>
        </div>

        <div class="row justify-content-center" style="--space-gap: var(--space-6);">
            <!-- Main Form Column -->
            <div class="col-lg-10 col-md-10">
                <div class="card">
                    <div class="card-body">
                        <form th:action="@{/admin/update-organization}" method="post">
                            <input type="hidden" name="id" th:value="${organization.id}">
                            
                            <!-- Organization Details Section -->
                            <div class="form-section">
                                <h5 class="form-section-title">Organization Details</h5>
                                
                                <div class="form-group">
                                    <label for="name" class="form-label">Organization Name</label>
                                    <input type="text" class="form-control" name="name" id="name" required th:value="${organization.name}">
                                    <small class="form-text">This is the public display name for the organization.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="address" class="form-label">Organization Address</label>
                                    <input type="text" class="form-control" name="address" id="address" th:value="${organization.address}">
                                    <small class="form-text">This is the publicly displayed address for the organization.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="site-url" class="form-label">Website</label>
                                    <input type="text" class="form-control" name="site-url" id="site-url" th:value="${organization.websiteURIStr}">
                                    <small class="form-text">Optional: This website link will be displayed publically. Make sure NOT to include http://</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="url-slug" class="form-label">URL Slug</label>
                                    <input type="text" class="form-control" name="url-slug" id="url-slug" th:value="${organization.urlSlug}" pattern="[a-z0-9\-]+">
                                    <small class="form-text">Human-readable URL for this organization (e.g., "keter-torah"). Only lowercase letters, numbers, and hyphens allowed. Leave blank to auto-generate from organization name.</small>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="nusach" class="form-label">Nusach</label>
                                            <select class="form-control" name="nusach" id="nusach">
                                                <option value="unspecified" th:selected="${organization.getNusach().isUnspecified()}">None specified</option>
                                                <option value="arizal" th:selected="${organization.getNusach().isArizal()}">Arizal</option>
                                                <option value="edot_hamizrach" th:selected="${organization.getNusach().isEdotHamizrach()}">Edot HaMizrach</option>
                                                <option value="sefard" th:selected="${organization.getNusach().isSefard()}">Sefard</option>
                                                <option value="ashkenaz" th:selected="${organization.getNusach().isAshkenaz()}">Ashkenaz</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="orgColor" class="form-label">Shul Color</label>
                                            <input type="color" class="form-control form-control-color" name="orgColor" id="orgColor" th:value="${organization.getOrgColor()}" title="Choose your color">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Calendar Import Settings Section -->
                            <div class="form-section">
                                <h5 class="form-section-title">Calendar Import Settings</h5>
                                <p class="text-muted small mb-3">Import minyan times from your calendar system instead of using rule-based generation.</p>
                                
                                <div class="form-group">
                                    <label for="calendar" class="form-label">Calendar URL</label>
                                    <input type="url" class="form-control" name="calendar" id="calendar" th:value="${organization.calendar}" placeholder="https://example.com/calendar">
                                    <small class="form-text">
                                        Enter the base URL of your calendar system. The system will automatically append parameters to fetch CSV exports.
                                        <br>Example: https://www.torahtimes.org/calendar (for Torah Times calendar)
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" name="useScrapedCalendar" id="useScrapedCalendar" 
                                               th:checked="${organization.useScrapedCalendar}">
                                        <label class="custom-control-label" for="useScrapedCalendar">
                                            Enable Calendar Import
                                        </label>
                                    </div>
                                    <small class="form-text">
                                        When enabled, minyan times will be imported from the calendar URL instead of using rule-based schedules.
                                        <span th:if="${organization.calendar != null and organization.calendar != ''}">
                                            <br><a th:href="@{/admin/{orgId}/calendar-entries(orgId=${organization.id})}" class="btn-modern btn-sm btn-outline mt-2">
                                                <i class="fas fa-calendar-alt"></i> Manage Imported Entries
                                            </a>
                                        </span>
                                    </small>
                                </div>
                            </div>
                            
                            <div th:if="${updateError}" class="alert alert-danger mt-3">
                                <i class="fas fa-exclamation-circle"></i>
                                <span th:text="${updateError}"></span>
                            </div>
                            
                            <button type="submit" class="btn-modern btn-primary">
                                <i class="fas fa-save"></i>
                                <span>Update Organization</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Associated Accounts Section -->
                <div class="card mt-4" th:if="${user.isAdmin()}" sec:authorize="hasRole('ROLE_ADMIN')">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <h5 class="mb-0">Associated Accounts</h5>
                            <div class="ml-auto">
                                <button type="button" class="btn-modern btn-sm btn-outline" data-toggle="modal" data-target="#add-account-modal">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Account</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="user: ${associatedusers}">
                                        <td th:text="${user.id}"></td>
                                        <td th:text="${user.username}"></td>
                                        <td th:text="${user.email}"></td>
                                        <td>
                                            <span class="badge badge-primary" th:text="${user.getRoleDisplayName()}"></span>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn-modern btn-sm btn-warning" 
                                                        th:disabled="${associatedusers.size() <= 1}" 
                                                        data-toggle="modal" 
                                                        th:data-target="${'#disable-account-modal-' + user.id}">
                                                    <i class="fas fa-ban"></i> Disable
                                                </button>
                                                <a class="btn-modern btn-sm btn-secondary" role="button" th:href="@{/admin/account(id=${user.id})}">
                                                    <i class="fas fa-cog"></i> Manage
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Modals -->
        <!-- Add Account Modal -->
        <div class="modal fade" id="add-account-modal" tabindex="-1" aria-labelledby="add-account-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="add-account-modal-label">Add an Account</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">Ã—</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>This account will have user privileges associated with <span th:text="${organization.name}"></span>. To create an admin account, visit the <a href="/admin/new-account">create an account</a> page.</p>
                        <form method="post" th:action="@{/admin/create-account?r=u&oid=} + ${organization.id}">
                            <div class="form-group">
                                <label for="new-account-username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="new-account-username" name="username" required>
                                <small class="form-text">This is how the user will log into the admin panel.</small>
                            </div>
                            <div class="form-group">
                                <label for="new-account-email" class="form-label">Email address</label>
                                <input type="email" class="form-control" id="new-account-email" name="email" required>
                                <small class="form-text">This email will be used for password recovery.</small>
                            </div>
                            <div class="form-group">
                                <label for="new-password" class="form-label">Password</label>
                                <input type="password" class="form-control" name="password" id="new-password" required>
                            </div>
                            <div class="form-group">
                                <label for="new-cpassword" class="form-label">Confirm Password</label>
                                <input type="password" class="form-control" name="cpassword" id="new-cpassword" required>
                            </div>
                            <div th:if="${addAccountError}" class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i>
                                <span th:text="${addAccountError}"></span>
                            </div>
                            <hr>
                            <button type="submit" class="btn-modern btn-primary">
                                <i class="fas fa-user-plus"></i> Create Account
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script th:if="${addAccountError}">
            $(document).ready(function() {
                $('#add-account-modal').modal('show');
            });
        </script>
    </div>
</body>
</html>
