<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Application Settings - Teaneck Minyanim</title>
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <link rel="icon" type="image/png" href="/assets/icons/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#275ed8">
    
    <meta name="msapplication-TileColor" content="#275ed8">
    <meta name="msapplication-config" content="/assets/icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-timezone-all@0.5.5/builds/moment-timezone-with-data.min.js"></script>
    
    <style>
        .settings-section {
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1.5rem;
            background-color: #fff;
        }
        .settings-section h4 {
            color: #495057;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        .setting-row {
            padding: 1rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .setting-row:last-child {
            border-bottom: none;
        }
        .setting-label {
            font-weight: 600;
            color: #212529;
            margin-bottom: 0.25rem;
        }
        .setting-description {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        .setting-value {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
        }
        .alert-custom {
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
<div class="horizontal-container">
    <th:block th:include="admin/navbar"></th:block>
    <div class="container-fluid" id="main">
        <div class="row row-offcanvas row-offcanvas-left vh-100">
            <th:block th:include="admin/sidebar"></th:block>
            
            <div class="col-housing main h-100 overflow-auto">
                <main class="col main pt-5 mt-3 overflow-auto">
                    <h3 class="lead d-sm-block">Application Settings</h3>
                    <p class="text-muted">Configure application-wide settings and notifications</p>
                    
                    <hr class="d-none d-sm-block">
                    
                    <!-- Success/Error Messages -->
                    <div th:if="${success}" class="alert alert-success alert-dismissible fade show alert-custom" role="alert">
                        <strong>Success!</strong> <span th:text="${success}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    
                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show alert-custom" role="alert">
                        <strong>Error!</strong> <span th:text="${error}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="row my-4" style="padding-bottom: 60px">
                        <div class="col-lg-10">
                            
                            <!-- Application Settings (Location, Timezone, Calendar) -->
                            <h3 class="mb-3">System Configuration</h3>
                            <div th:each="category : ${applicationSettingsByCategory.keySet()}" class="settings-section">
                                <h4 th:text="${category}"></h4>
                                
                                <div th:each="setting : ${applicationSettingsByCategory.get(category)}" class="setting-row">
                                    <div class="setting-label" th:text="${setting.settingKey}"></div>
                                    <div class="setting-description" th:text="${setting.description}"></div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="setting-value" th:text="${setting.settingValue}"></div>
                                        </div>
                                        <div class="col-md-6 text-right">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    th:data-key="${setting.settingKey}"
                                                    th:data-value="${setting.settingValue}"
                                                    th:data-type="${setting.settingType}"
                                                    th:data-description="${setting.description}"
                                                    data-toggle="modal" 
                                                    data-target="#editAppSettingModal"
                                                    onclick="prepareEditModal(this)">
                                                Edit
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notification Settings (TNMSettings) -->
                            <h3 class="mb-3 mt-5">Notification Settings</h3>
                            <div class="settings-section">
                                <h4>Homepage Notifications</h4>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Setting</th>
                                                <th>Enabled</th>
                                                <th class="text-wrap" style="max-width: 200px;">Message</th>
                                                <th>Expiration</th>
                                                <th>Max Displays</th>
                                                <th>Edit</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="settings: ${notificationSettings}">
                                                <td th:text="${settings.setting}"></td>
                                                <td>
                                                    <span class="badge badge-success" th:if="${settings.enabled} == 'Enabled'">Enabled</span>
                                                    <span class="badge badge-danger" th:if="${settings.enabled} == 'Disabled'">Disabled</span>
                                                    <span class="badge badge-secondary" th:if="${settings.enabled} == 'n/a'">N/A</span>
                                                </td>
                                                <td class="text-wrap" style="max-width: 200px; word-wrap: break-word; white-space: normal;" th:text="${settings.text}"></td>
                                                <td th:text="${settings.expirationDate != null ? settings.expirationDate : 'N/A'}"></td>
                                                <td th:text="${settings.maxDisplays != null ? settings.maxDisplays : 'N/A'}"></td>
                                                <td>
                                                    <button class="btn btn-outline-dark btn-sm" data-toggle="modal" th:data-target="${'#update-notification-modal-' + settings.id}">Edit</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
</div>

<!-- Edit Application Setting Modal -->
<div class="modal fade" id="editAppSettingModal" tabindex="-1" aria-labelledby="editAppSettingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAppSettingModalLabel">Edit Application Setting</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" th:action="@{/admin/settings/update-application-setting}" id="editAppSettingForm">
                <div class="modal-body">
                    <input type="hidden" name="settingKey" id="modalSettingKey">
                    
                    <div class="form-group">
                        <label>Setting Key</label>
                        <input type="text" class="form-control" id="modalSettingKeyDisplay" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <p class="form-text text-muted" id="modalSettingDescription"></p>
                    </div>
                    
                    <div class="form-group">
                        <label for="modalSettingValue">Value <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="settingValue" id="modalSettingValue" required>
                        <small class="form-text text-muted" id="modalValueHint"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Notification Settings Modals -->
<div th:each="settings: ${notificationSettings}">
    <div class="modal fade" th:id="${'update-notification-modal-' + settings.id}" tabindex="-1" th:aria-labelledby="${'update-notification-modal-label-' + settings.id}" style="display: none;" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title h4" th:id="${'update-notification-modal-label-' + settings.id}">Edit Notification</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">Ã—</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" th:action="@{/admin/update-settings}">
                        <div class="form-group">
                            <input type="hidden" name="id" th:value="${settings.id}">
                            <input type="hidden" name="setting" th:value="${settings.setting}">
                            <input type="hidden" name="type" th:value="${settings.type}">
                            <h4 th:text="${settings.setting}"></h4>
                            <div class="form-group">
                                <label for="enabled">Enabled</label>
                                <select class="form-control" name="enabled" th:id="${'new-enabled-' + settings.id}" th:disabled="${settings.enabled == 'n/a'}">
                                    <option th:value="'Enabled'" th:selected="${settings.enabled == 'Enabled'}">Enabled</option>
                                    <option th:value="'Disabled'" th:selected="${settings.enabled == 'Disabled'}">Disabled</option>
                                </select>
                                <input type="hidden" name="enabledHidden" th:value="${settings.enabled == 'n/a' ? 'n/a' : settings.enabled}">
                            </div>
                            
                            <div class="form-group">
                                <label for="text">Message Text (Markdown Supported)</label>
                                <textarea class="form-control" th:id="${'new-text-' + settings.id}" name="text" rows="5" th:text="${settings.text}"></textarea>
                                <small class="form-text text-muted">
                                    Supports markdown: **bold**, *italic*, [link](url), `code`, - list items, ## headers
                                </small>
                            </div>

                            <div class="form-group mt-3">
                                <label th:for="${'new-expiration-date-' + settings.id}">Expiration Date (Optional)</label>
                                <input type="date" class="form-control" th:id="${'new-expiration-date-' + settings.id}" name="expirationDate" th:value="${settings.expirationDate}">
                                <small class="form-text text-muted">Leave empty for no expiration. Format: YYYY-MM-DD</small>
                            </div>

                            <div class="form-group">
                                <label th:for="${'new-max-displays-' + settings.id}">Max Displays Per User (Optional)</label>
                                <input type="number" class="form-control" th:id="${'new-max-displays-' + settings.id}" name="maxDisplays" th:value="${settings.maxDisplays}" min="1" max="100">
                                <small class="form-text text-muted">Leave empty for unlimited displays. Max: 100</small>
                            </div>

                        </div>
                        <hr>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function prepareEditModal(button) {
        const key = button.getAttribute('data-key');
        const value = button.getAttribute('data-value');
        const type = button.getAttribute('data-type');
        const description = button.getAttribute('data-description');
        
        document.getElementById('modalSettingKey').value = key;
        document.getElementById('modalSettingKeyDisplay').value = key;
        document.getElementById('modalSettingValue').value = value;
        document.getElementById('modalSettingDescription').textContent = description;
        
        // Set input hints based on type
        let hint = '';
        if (type === 'DOUBLE') {
            hint = 'Enter a decimal number (e.g., 40.906871)';
        } else if (type === 'INTEGER') {
            hint = 'Enter a whole number (e.g., 30)';
        } else if (type === 'STRING') {
            if (key.includes('timezone')) {
                hint = 'Enter a valid timezone ID (e.g., America/New_York)';
            } else if (key.includes('cron')) {
                hint = 'Enter a valid cron expression (e.g., 0 0 2 * * SUN)';
            } else {
                hint = 'Enter a text value';
            } 
        }
        document.getElementById('modalValueHint').textContent = hint;
    }
    
    // Auto-dismiss alerts after 5 seconds
    setTimeout(function() {
        $('.alert').fadeOut('slow');
    }, 5000);
</script>

</body>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script th:src="@{/account.js}"></script>
<script th:src="@{/admin/timezone.js}"></script>
</html>
