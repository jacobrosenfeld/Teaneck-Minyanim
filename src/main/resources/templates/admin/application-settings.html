<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title th:text="@{|Application Settings - ${siteName} ?: 'Minyan Manager'|}">Application Settings - Minyan Manager</title>
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <link rel="icon" type="image/png" href="/assets/icons/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#275ed8">
    
    <meta name="msapplication-TileColor" content="#275ed8">
    <meta name="msapplication-config" content="/assets/icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    
    <style>
        .settings-section {
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1.5rem;
            background-color: #fff;
        }
        .settings-section h4 {
            color: #495057;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        .setting-row {
            padding: 1rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .setting-row:last-child {
            border-bottom: none;
        }
        .setting-label {
            font-weight: 600;
            color: #212529;
            margin-bottom: 0.25rem;
        }
        .setting-description {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        .setting-value {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
        }
        .alert-custom {
            margin-bottom: 1.5rem;
        }
        .btn-refresh {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
<div class="horizontal-container">
    <th:block th:include="admin/navbar"></th:block>
    <div class="container-fluid" id="main">
        <div class="row row-offcanvas row-offcanvas-left vh-100">
            <th:block th:include="admin/sidebar"></th:block>
            
            <div class="col-housing main h-100 overflow-auto">
                <main class="col main pt-5 mt-3 overflow-auto">
                    <h3 class="lead d-sm-block">Application Settings</h3>
                    <p class="text-muted">Configure application-wide settings that affect all organizations.</p>
                    
                    <hr class="d-none d-sm-block">
                    
                    <!-- Success/Error Messages -->
                    <div th:if="${success}" class="alert alert-success alert-dismissible fade show alert-custom" role="alert">
                        <strong>Success!</strong> <span th:text="${success}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    
                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show alert-custom" role="alert">
                        <strong>Error!</strong> <span th:text="${error}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <!-- Settings by Category -->
                    <div class="row my-4" style="padding-bottom: 60px">
                        <div class="col-lg-10">
                            <div th:each="category : ${settingsByCategory.keySet()}" class="settings-section">
                                <h4 th:text="${category}"></h4>
                                
                                <div th:each="setting : ${settingsByCategory.get(category)}" class="setting-row">
                                    <div class="setting-label" th:text="${setting.settingKey}"></div>
                                    <div class="setting-description" th:text="${setting.description}"></div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="setting-value" th:text="${setting.settingValue}"></div>
                                        </div>
                                        <div class="col-md-6 text-right">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    th:data-key="${setting.settingKey}"
                                                    th:data-value="${setting.settingValue}"
                                                    th:data-type="${setting.settingType}"
                                                    th:data-description="${setting.description}"
                                                    data-toggle="modal" 
                                                    data-target="#editSettingModal"
                                                    onclick="prepareEditModal(this)">
                                                Edit
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cache Management -->
                            <div class="settings-section">
                                <h4>Cache Management</h4>
                                <p>Settings are cached for performance. If you make manual database changes, refresh the cache here.</p>
                                <form method="post" th:action="@{/admin/application-settings/refresh-cache}">
                                    <button type="submit" class="btn btn-secondary btn-refresh">
                                        Refresh Settings Cache
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
</div>

<!-- Edit Setting Modal -->
<div class="modal fade" id="editSettingModal" tabindex="-1" aria-labelledby="editSettingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSettingModalLabel">Edit Setting</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" th:action="@{/admin/application-settings/update}" id="editSettingForm">
                <div class="modal-body">
                    <input type="hidden" name="settingKey" id="modalSettingKey">
                    
                    <div class="form-group">
                        <label>Setting Key</label>
                        <input type="text" class="form-control" id="modalSettingKeyDisplay" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <p class="form-text text-muted" id="modalSettingDescription"></p>
                    </div>
                    
                    <div class="form-group">
                        <label for="modalSettingValue">Value <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center" id="settingValueWrapper">
                            <input type="color" class="form-control" id="modalSettingColorPicker" style="max-width: 140px; display: none;">
                            <input type="text" class="form-control" name="settingValue" id="modalSettingValue" required>
                        </div>
                        <small class="form-text text-muted" id="modalValueHint"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const colorPicker = document.getElementById('modalSettingColorPicker');
    const settingValueInput = document.getElementById('modalSettingValue');
    const valueHint = document.getElementById('modalValueHint');

    function normalizeHexColor(rawValue) {
        if (!rawValue) {
            return '';
        }
        const trimmed = rawValue.trim();
        const match = trimmed.match(/^#?[0-9a-fA-F]{6}$/);
        if (!match) {
            return '';
        }
        return trimmed.startsWith('#') ? trimmed.toLowerCase() : `#${trimmed.toLowerCase()}`;
    }

    function showColorPicker(value) {
        const normalized = normalizeHexColor(value) || '#275ed8';
        colorPicker.style.display = 'block';
        settingValueInput.classList.add('ml-2');
        settingValueInput.setAttribute('pattern', '#[0-9a-fA-F]{6}');
        colorPicker.value = normalized;
        settingValueInput.value = normalized;
    }

    function hideColorPicker(value) {
        colorPicker.style.display = 'none';
        settingValueInput.classList.remove('ml-2');
        settingValueInput.removeAttribute('pattern');
        settingValueInput.value = value;
    }

    colorPicker.addEventListener('input', function() {
        if (colorPicker.style.display === 'none') {
            return;
        }
        settingValueInput.value = colorPicker.value;
    });
    
    settingValueInput.addEventListener('input', function() {
        if (colorPicker.style.display === 'none') {
            return;
        }
        const normalized = normalizeHexColor(settingValueInput.value);
        if (normalized) {
            colorPicker.value = normalized;
        }
    });

    function prepareEditModal(button) {
        const key = button.getAttribute('data-key');
        const value = button.getAttribute('data-value');
        const type = button.getAttribute('data-type');
        const description = button.getAttribute('data-description');
        
        document.getElementById('modalSettingKey').value = key;
        document.getElementById('modalSettingKeyDisplay').value = key;
        document.getElementById('modalSettingDescription').textContent = description;
        
        // Set input hints based on type
        let hint = '';
        if (type === 'DOUBLE') {
            hint = 'Enter a decimal number (e.g., 40.906871)';
        } else if (type === 'INTEGER') {
            hint = 'Enter a whole number (e.g., 30)';
        } else if (type === 'STRING') {
            if (key.includes('timezone')) {
                hint = 'Enter a valid timezone ID (e.g., America/New_York)';
            } else if (key.includes('cron')) {
                hint = 'Enter a valid cron expression (e.g., 0 0 2 * * SUN)';
            } else {
                hint = 'Enter a text value';
            }
        }

        if (key === 'site.app.color') {
            showColorPicker(value);
            hint = 'Pick a hex color (#RRGGBB).';
        } else {
            hideColorPicker(value);
        }

        valueHint.textContent = hint;
    }
    
    // Auto-dismiss alerts after 5 seconds
    setTimeout(function() {
        $('.alert').fadeOut('slow');
    }, 5000);
</script>

</body>
</html>
