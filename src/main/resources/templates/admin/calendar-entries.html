<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Calendar Entries - [[${organization.name}]]</title>
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <link rel="icon" type="image/png" href="/assets/icons/favicon.png">
    <style>
        /* Modern table styling */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .entries-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }
        
        .entries-table thead {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }
        
        .entries-table th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
        
        .entries-table th.sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .entries-table th.sortable:hover {
            background-color: #f8f9fa;
        }
        
        .entries-table th .sort-indicator {
            margin-left: 0.25rem;
            opacity: 0.3;
        }
        
        .entries-table th.sorted .sort-indicator {
            opacity: 1;
        }
        
        .entries-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .entries-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .entries-table tbody tr.disabled {
            opacity: 0.6;
        }
        
        /* Filter panel */
        .filter-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
        }
        
        /* Badge styles */
        .badge-minyan {
            background-color: #28a745;
        }
        
        .badge-mincha-maariv {
            background-color: #17a2b8;
        }
        
        .badge-non-minyan {
            background-color: #6c757d;
        }
        
        .badge-other {
            background-color: #ffc107;
            color: #000;
        }
        
        /* Prayer type pills (based on title text) */
        .prayer-pill {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.25rem;
        }
        
        .prayer-pill-shacharis {
            background-color: #007bff;
            color: #fff;
        }
        
        .prayer-pill-mincha {
            background-color: #ffc107;
            color: #000;
        }
        
        .prayer-pill-maariv {
            background-color: #6f42c1;
            color: #fff;
        }
        
        .prayer-pill-mincha-maariv {
            background-color: #17a2b8;
            color: #fff;
        }
        
        /* Statistics */
        .stats-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background: white;
        }
        
        .stat-card .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .stat-card .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        /* Notes column */
        .notes-cell {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Inline editing */
        .editable-cell {
            position: relative;
        }
        
        .edit-trigger {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .edit-trigger:hover {
            background-color: #e9ecef;
        }
        
        .edit-form {
            display: inline-flex;
            gap: 0.25rem;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        .edit-form select {
            min-width: 150px;
            max-width: 200px;
        }
        
        .edit-form .btn {
            padding: 0.25rem 0.5rem;
            line-height: 1.2;
        }
        
        .manually-edited-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #17a2b8;
            margin-left: 0.25rem;
            vertical-align: middle;
            title: "Manually edited";
        }
    </style>
</head>
<body>
<div class="horizontal-container d-flex" id="wrapper">
    <th:block th:include="admin/navbar"></th:block>
    <div class="container-fluid" id="main">
        <div class="row row-offcanvas row-offcanvas-left vh-100">
            <th:block th:include="admin/sidebar"></th:block>
            <div class="col-housing main h-100 overflow-auto">
                <main class="col main pt-5 mt-3 overflow-auto">
                    <!-- Alert Messages -->
                    <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${successMessage}">
                        <span th:text="${successMessage}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert" th:if="${errorMessage}">
                        <span th:text="${errorMessage}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    
                    <!-- Page Header -->
                    <h1 class="display-4 d-none d-sm-block">Manage Imported Entries</h1>
                    <p class="lead" th:text="${organization.name}"></p>

                    <hr>

                    <!-- Import Controls -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Calendar Import Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-2">
                                                <strong>Calendar URL:</strong><br>
                                                <span th:if="${organization.calendar}" th:text="${organization.calendar}" class="small"></span>
                                                <span th:unless="${organization.calendar}" class="text-muted">Not configured</span>
                                            </p>
                                            <p class="mb-2">
                                                <strong>Import Status:</strong> 
                                                <span th:if="${organization.useScrapedCalendar}" class="badge badge-success">Enabled</span>
                                                <span th:unless="${organization.useScrapedCalendar}" class="badge badge-secondary">Disabled</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <form th:action="@{/admin/{orgId}/calendar/import(orgId=${organization.id})}" method="post" style="display: inline;">
                                                <button type="submit" class="btn btn-primary mb-2" 
                                                        th:disabled="${organization.calendar == null or organization.calendar.isEmpty()}">
                                                    <i class="fas fa-sync"></i> Refresh Import
                                                </button>
                                            </form>
                                            
                                            <form th:action="@{/admin/{orgId}/calendar/reimport-all(orgId=${organization.id})}" 
                                                  method="post" 
                                                  style="display: inline;"
                                                  onsubmit="return confirm('This will delete ALL existing entries and reimport from scratch. Any manual edits will be lost. Are you sure?');">
                                                <button type="submit" class="btn btn-warning mb-2" 
                                                        th:disabled="${organization.calendar == null or organization.calendar.isEmpty()}">
                                                    <i class="fas fa-redo"></i> Reimport All (Override)
                                                </button>
                                            </form>
                                            
                                            <a th:href="@{/admin/organization(id=${organization.id})}" class="btn btn-secondary mb-2">
                                                <i class="fas fa-arrow-left"></i> Back to Organization
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-value" th:text="${totalEntries}">0</div>
                            <div class="stat-label">Total Entries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-success" th:text="${minyanCount}">0</div>
                            <div class="stat-label">Minyan Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-info" th:text="${enabledCount}">0</div>
                            <div class="stat-label">Enabled</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-muted" th:text="${disabledCount}">0</div>
                            <div class="stat-label">Disabled</div>
                        </div>
                        <div class="stat-card" th:if="${showNonMinyan}">
                            <div class="stat-value text-secondary" th:text="${nonMinyanCount}">0</div>
                            <div class="stat-label">Non-Minyan</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-filter"></i> Filters & Search
                                <span th:if="${filteredCount != totalEntries}" class="badge badge-info ml-2">
                                    Showing [[${filteredCount}]] of [[${totalEntries}]]
                                </span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="get" th:action="@{/admin/{orgId}/calendar-entries(orgId=${organization.id})}" id="filterForm">
                                <div class="filter-row">
                                    <!-- Search Text -->
                                    <div class="filter-group">
                                        <label for="searchText">Search</label>
                                        <input type="text" class="form-control" id="searchText" name="searchText" 
                                               th:value="${searchText}" placeholder="Title, location, notes...">
                                    </div>
                                    
                                    <!-- Classification Filter -->
                                    <div class="filter-group">
                                        <label for="filterClassification">Event Type</label>
                                        <select class="form-control" id="filterClassification" name="filterClassification">
                                            <option value="">All Types</option>
                                            <option value="MINYAN" th:selected="${filterClassification == 'MINYAN'}">Minyan</option>
                                            <option value="MINCHA_MAARIV" th:selected="${filterClassification == 'MINCHA_MAARIV'}">Mincha/Maariv</option>
                                            <option value="OTHER" th:selected="${filterClassification == 'OTHER'}">Other</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Enabled Filter -->
                                    <div class="filter-group">
                                        <label for="filterEnabled">Status</label>
                                        <select class="form-control" id="filterEnabled" name="filterEnabled">
                                            <option value="">All</option>
                                            <option value="true" th:selected="${filterEnabled == 'true'}">Enabled Only</option>
                                            <option value="false" th:selected="${filterEnabled == 'false'}">Disabled Only</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Date Range -->
                                    <div class="filter-group">
                                        <label for="startDate">Start Date</label>
                                        <input type="date" class="form-control" id="startDate" name="startDate" th:value="${startDate}">
                                    </div>
                                    
                                    <div class="filter-group">
                                        <label for="endDate">End Date</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate" th:value="${endDate}">
                                    </div>
                                    
                                    <!-- Show Non-Minyan Toggle -->
                                    <div class="filter-group" style="min-width: auto;">
                                        <label for="showNonMinyan">Non-Minyan</label>
                                        <div class="form-check" style="padding-top: 0.375rem;">
                                            <input class="form-check-input" type="checkbox" id="showNonMinyan" 
                                                   name="showNonMinyan" value="true" th:checked="${showNonMinyan}">
                                            <label class="form-check-label" for="showNonMinyan">
                                                Show
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="filter-group" style="min-width: auto;">
                                        <label>&nbsp;</label>
                                        <div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search"></i> Apply
                                            </button>
                                            <a th:href="@{/admin/{orgId}/calendar-entries(orgId=${organization.id})}" 
                                               class="btn btn-secondary">
                                                <i class="fas fa-times"></i> Clear
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hidden sort fields -->
                                <input type="hidden" name="sortBy" th:value="${sortBy}">
                                <input type="hidden" name="sortDir" th:value="${sortDir}">
                            </form>
                        </div>
                    </div>

                    <!-- Entries Table -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar"></i> Entries
                                <small class="text-muted">([[${filteredCount}]] entries)</small>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- Empty State -->
                            <div th:if="${entries.isEmpty()}" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h4>No entries found</h4>
                                <p th:if="${searchText != null or filterClassification != null or filterEnabled != null}">
                                    Try adjusting your filters or <a th:href="@{/admin/{orgId}/calendar-entries(orgId=${organization.id})}">clear all filters</a>.
                                </p>
                                <p th:unless="${searchText != null or filterClassification != null or filterEnabled != null}">
                                    Click "Refresh Import" above to import entries from your calendar.
                                </p>
                            </div>
                            
                            <!-- Table -->
                            <div th:unless="${entries.isEmpty()}" class="table-container">
                                <table class="entries-table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="sortable" th:classappend="${sortBy == 'date'} ? 'sorted'"
                                                onclick="sortTable('date')">
                                                Date
                                                <span class="sort-indicator">
                                                    <i th:class="${sortBy == 'date' and sortDir == 'asc'} ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                                                </span>
                                            </th>
                                            <th class="sortable" th:classappend="${sortBy == 'time'} ? 'sorted'"
                                                onclick="sortTable('time')">
                                                Time
                                                <span class="sort-indicator">
                                                    <i th:class="${sortBy == 'time' and sortDir == 'asc'} ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                                                </span>
                                            </th>
                                            <th class="sortable" th:classappend="${sortBy == 'title'} ? 'sorted'"
                                                onclick="sortTable('title')">
                                                Title
                                                <span class="sort-indicator">
                                                    <i th:class="${sortBy == 'title' and sortDir == 'asc'} ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                                                </span>
                                            </th>
                                            <th class="sortable" th:classappend="${sortBy == 'type'} ? 'sorted'"
                                                onclick="sortTable('type')">
                                                Type
                                                <span class="sort-indicator">
                                                    <i th:class="${sortBy == 'type' and sortDir == 'asc'} ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                                                </span>
                                            </th>
                                            <th>Location</th>
                                            <th>Notes</th>
                                            <th class="sortable" th:classappend="${sortBy == 'enabled'} ? 'sorted'"
                                                onclick="sortTable('enabled')">
                                                Status
                                                <span class="sort-indicator">
                                                    <i th:class="${sortBy == 'enabled' and sortDir == 'asc'} ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                                                </span>
                                            </th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="entry : ${entries}" 
                                            th:classappend="${!entry.enabled} ? 'disabled' : ''">
                                            <td th:text="${#temporals.format(entry.date, 'MMM dd, yyyy')}"></td>
                                            <td th:text="${entry.startTime != null ? #temporals.format(entry.startTime, 'h:mm a') : 'N/A'}"></td>
                                            <td>
                                                <span th:attr="data-title=${entry.title}" class="prayer-type-pill"></span>
                                                <strong th:text="${entry.title}"></strong>
                                                <br th:if="${entry.classificationReason}">
                                                <small class="text-muted" th:if="${entry.classificationReason}" 
                                                       th:text="${entry.classificationReason}"></small>
                                            </td>
                                            <td>
                                                <span th:if="${entry.classification}" 
                                                      th:class="${'badge badge-' + (entry.classification.name() == 'MINYAN' ? 'minyan' : 
                                                                                    entry.classification.name() == 'MINCHA_MAARIV' ? 'mincha-maariv' :
                                                                                    entry.classification.name() == 'NON_MINYAN' ? 'non-minyan' : 'other')}"
                                                      th:text="${entry.classification.displayName}">
                                                </span>
                                                <span th:unless="${entry.classification}" class="text-muted">—</span>
                                            </td>
                                            <td class="editable-cell">
                                                <!-- Display mode -->
                                                <span th:id="'location-display-' + ${entry.id}" 
                                                      th:attr="data-entry-id=${entry.id}"
                                                      class="edit-trigger"
                                                      onclick="editLocation(this)">
                                                    <span th:text="${entry.location ?: 'Add location'}"></span>
                                                    <span th:if="${entry.locationManuallyEdited}" 
                                                          class="manually-edited-indicator" 
                                                          title="Manually edited"></span>
                                                    <i class="fas fa-pencil-alt" style="font-size: 0.75rem; opacity: 0.5; margin-left: 0.25rem;"></i>
                                                </span>
                                                
                                                <!-- Edit mode (hidden by default) -->
                                                <form th:id="'location-form-' + ${entry.id}"
                                                      th:action="@{/admin/{orgId}/calendar-entries/{entryId}/update-location(orgId=${organization.id},entryId=${entry.id})}" 
                                                      method="post" 
                                                      class="edit-form" 
                                                      style="display: none;">
                                                    <select name="locationId" class="form-control form-control-sm">
                                                        <option value="">-- No location --</option>
                                                        <option th:each="loc : ${locations}" 
                                                                th:value="${loc.id}" 
                                                                th:text="${loc.name}"
                                                                th:selected="${entry.location != null and entry.location == loc.name}">
                                                        </option>
                                                    </select>
                                                    <button type="submit" class="btn btn-sm btn-success">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-secondary" 
                                                            onclick="cancelEdit(this)">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </form>
                                            </td>
                                            <td>
                                                <span class="notes-cell" th:if="${entry.notes}" th:text="${entry.notes}"></span>
                                                <span th:unless="${entry.notes}" class="text-muted">—</span>
                                            </td>
                                            <td>
                                                <span th:if="${entry.enabled}" class="badge badge-success">Enabled</span>
                                                <span th:unless="${entry.enabled}" class="badge badge-secondary">Disabled</span>
                                                <small th:if="${entry.duplicateReason}" 
                                                       class="text-muted d-block mt-1" 
                                                       th:text="${entry.duplicateReason}"></small>
                                            </td>
                                            <td>
                                                <form th:action="@{/admin/{orgId}/calendar-entries/{entryId}/toggle(orgId=${organization.id},entryId=${entry.id})}" 
                                                      method="post" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm" 
                                                            th:classappend="${entry.enabled} ? 'btn-outline-secondary' : 'btn-outline-success'">
                                                        <i th:class="${entry.enabled} ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                                        <span th:if="${entry.enabled}">Disable</span>
                                                        <span th:unless="${entry.enabled}">Enable</span>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>
</div>

<script>
    function sortTable(column) {
        const form = document.getElementById('filterForm');
        const sortByInput = form.querySelector('input[name="sortBy"]');
        const sortDirInput = form.querySelector('input[name="sortDir"]');
        
        // Toggle sort direction if clicking same column
        if (sortByInput.value === column) {
            sortDirInput.value = sortDirInput.value === 'asc' ? 'desc' : 'asc';
        } else {
            sortByInput.value = column;
            sortDirInput.value = 'asc';
        }
        
        form.submit();
    }
    
    function editLocation(trigger) {
        const entryId = trigger.getAttribute('data-entry-id');
        const displaySpan = document.getElementById('location-display-' + entryId);
        const editForm = document.getElementById('location-form-' + entryId);
        
        if (displaySpan && editForm) {
            displaySpan.style.display = 'none';
            editForm.style.display = 'inline-flex';
            editForm.querySelector('select').focus();
        }
    }
    
    function cancelEdit(button) {
        const form = button.closest('.edit-form');
        const entryId = form.id.replace('location-form-', '');
        const displaySpan = document.getElementById('location-display-' + entryId);
        
        if (displaySpan && form) {
            form.style.display = 'none';
            displaySpan.style.display = 'inline';
        }
    }
    
    // Add prayer type pills based on title text
    document.addEventListener('DOMContentLoaded', function() {
        const pillElements = document.querySelectorAll('.prayer-type-pill');
        
        pillElements.forEach(pill => {
            const title = (pill.getAttribute('data-title') || '').toLowerCase();
            let pillClass = '';
            let pillText = '';
            
            // Check for combined Mincha/Maariv first (most specific)
            if ((title.includes('mincha') || title.includes('minchah')) && 
                (title.includes('maariv') || title.includes("ma'ariv") || title.includes('arvit'))) {
                pillClass = 'prayer-pill prayer-pill-mincha-maariv';
                pillText = 'Mincha/Maariv';
            }
            // Check for individual prayer types
            else if (title.includes('shacharis') || title.includes('shacharit') || title.includes('shaharit')) {
                pillClass = 'prayer-pill prayer-pill-shacharis';
                pillText = 'Shacharis';
            }
            else if (title.includes('mincha') || title.includes('minchah') || title.includes('minha')) {
                pillClass = 'prayer-pill prayer-pill-mincha';
                pillText = 'Mincha';
            }
            else if (title.includes('maariv') || title.includes("ma'ariv") || title.includes('arvit')) {
                pillClass = 'prayer-pill prayer-pill-maariv';
                pillText = 'Maariv';
            }
            
            // Only add pill if we detected a prayer type
            if (pillClass) {
                pill.className = pillClass;
                pill.textContent = pillText;
            }
        });
    });
</script>
</body>
</html>
