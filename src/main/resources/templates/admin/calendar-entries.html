<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Calendar Entries - [[${organization.name}]]</title>
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <link rel="icon" type="image/png" href="/assets/icons/favicon.png">
    
    <!-- Tabulator CSS -->
    <!-- Note: For production, consider hosting Tabulator locally or using SRI hashes for CDN resources -->
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.css" rel="stylesheet">
    
    <style>
        /* Tabulator customizations */
        #calendar-entries-table {
            font-size: 0.9rem;
        }
        
        .tabulator-row.disabled-row {
            opacity: 0.6;
            background-color: #f8f9fa;
        }
        
        .tabulator-cell {
            vertical-align: middle;
        }
        
        /* Filter panel */
        .filter-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
        }
        
        /* Badge styles */
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .badge-shacharis,
        .badge-mincha,
        .badge-maariv,
        .badge-selichos {
            background-color: #28a745;
            color: #fff;
        }
        
        .badge-mincha-maariv {
            background-color: #17a2b8;
            color: #fff;
        }
        
        .badge-non-minyan {
            background-color: #6c757d;
            color: #fff;
        }
        
        .badge-other {
            background-color: #ffc107;
            color: #000;
        }
        
        /* Prayer type pills (based on title text) */
        .prayer-pill {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.25rem;
        }
        
        .prayer-pill-shacharis {
            background-color: #007bff;
            color: #fff;
        }
        
        .prayer-pill-mincha {
            background-color: #ffc107;
            color: #000;
        }
        
        .prayer-pill-maariv {
            background-color: #6f42c1;
            color: #fff;
        }
        
        .prayer-pill-mincha-maariv {
            background-color: #17a2b8;
            color: #fff;
        }
        
        /* Statistics */
        .stats-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background: white;
        }
        
        .stat-card .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .stat-card .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        /* Notes column */
        .notes-cell {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
        }
        
        .manually-edited-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #17a2b8;
            margin-left: 0.25rem;
            vertical-align: middle;
            title: "Manually edited";
        }
        
        /* Action buttons in Tabulator */
        .tabulator-cell .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        /* Location editor */
        .location-editor {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .location-editor select {
            min-width: 150px;
        }
    </style>
</head>
<body>
<div class="horizontal-container d-flex" id="wrapper">
    <th:block th:include="admin/navbar"></th:block>
    <div class="container-fluid" id="main">
        <div class="row row-offcanvas row-offcanvas-left vh-100">
            <th:block th:include="admin/sidebar"></th:block>
            <div class="col-housing main h-100 overflow-auto">
                <main class="col main pt-5 mt-3 overflow-auto">
                    <!-- Alert Messages -->
                    <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${successMessage}">
                        <span th:text="${successMessage}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert" th:if="${errorMessage}">
                        <span th:text="${errorMessage}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    
                    <!-- Page Header -->
                    <h1 class="display-4 d-none d-sm-block">Manage Imported Entries</h1>
                    <p class="lead" th:text="${organization.name}"></p>

                    <hr>

                    <!-- Import Controls -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Calendar Import Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-2">
                                                <strong>Calendar URL:</strong><br>
                                                <span th:if="${organization.calendar}" th:text="${organization.calendar}" class="small"></span>
                                                <span th:unless="${organization.calendar}" class="text-muted">Not configured</span>
                                            </p>
                                            <p class="mb-2">
                                                <strong>Import Status:</strong> 
                                                <span th:if="${organization.useScrapedCalendar}" class="badge badge-success">Enabled</span>
                                                <span th:unless="${organization.useScrapedCalendar}" class="badge badge-secondary">Disabled</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <form th:action="@{/admin/{orgId}/calendar/import(orgId=${organization.id})}" method="post" style="display: inline;">
                                                <button type="submit" class="btn btn-primary mb-2" 
                                                        th:disabled="${organization.calendar == null or organization.calendar.isEmpty()}">
                                                    <i class="fas fa-sync"></i> Refresh Import
                                                </button>
                                            </form>
                                            
                                            <form th:action="@{/admin/{orgId}/calendar/reimport-all(orgId=${organization.id})}" 
                                                  method="post" 
                                                  style="display: inline;"
                                                  onsubmit="return confirm('This will delete ALL existing entries and reimport from scratch. Any manual edits will be lost. Are you sure?');">
                                                <button type="submit" class="btn btn-warning mb-2" 
                                                        th:disabled="${organization.calendar == null or organization.calendar.isEmpty()}">
                                                    <i class="fas fa-redo"></i> Reimport All (Override)
                                                </button>
                                            </form>
                                            
                                            <a th:href="@{/admin/organization(id=${organization.id})}" class="btn btn-secondary mb-2">
                                                <i class="fas fa-arrow-left"></i> Back to Organization
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-value" th:text="${totalEntries}">0</div>
                            <div class="stat-label">Total Entries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-success" th:text="${minyanCount}">0</div>
                            <div class="stat-label">Minyan Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-info" th:text="${enabledCount}">0</div>
                            <div class="stat-label">Enabled</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-muted" th:text="${disabledCount}">0</div>
                            <div class="stat-label">Disabled</div>
                        </div>
                        <div class="stat-card" th:if="${showNonMinyan}">
                            <div class="stat-value text-secondary" th:text="${nonMinyanCount}">0</div>
                            <div class="stat-label">Non-Minyan</div>
                        </div>
                    </div>

                    <!-- Filters (Hidden - Tabulator provides built-in filtering) -->
                    <div class="card mb-4" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-filter"></i> Filters & Search
                                <span th:if="${filteredCount != totalEntries}" class="badge badge-info ml-2">
                                    Showing [[${filteredCount}]] of [[${totalEntries}]]
                                </span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="get" th:action="@{/admin/{orgId}/calendar-entries(orgId=${organization.id})}" id="filterForm">
                                <div class="filter-row">
                                    <!-- Search Text -->
                                    <div class="filter-group">
                                        <label for="searchText">Search</label>
                                        <input type="text" class="form-control" id="searchText" name="searchText" 
                                               th:value="${searchText}" placeholder="Title, location, notes...">
                                    </div>
                                    
                                    <!-- Classification Filter -->
                                    <div class="filter-group">
                                        <label for="filterClassification">Event Type</label>
                                        <select class="form-control" id="filterClassification" name="filterClassification">
                                            <option value="">All Types</option>
                                            <option value="SHACHARIS" th:selected="${filterClassification == 'SHACHARIS'}">Shacharis</option>
                                            <option value="MINCHA" th:selected="${filterClassification == 'MINCHA'}">Mincha</option>
                                            <option value="MAARIV" th:selected="${filterClassification == 'MAARIV'}">Maariv</option>
                                            <option value="MINCHA_MAARIV" th:selected="${filterClassification == 'MINCHA_MAARIV'}">Mincha/Maariv</option>
                                            <option value="SELICHOS" th:selected="${filterClassification == 'SELICHOS'}">Selichos</option>
                                            <option value="NON_MINYAN" th:selected="${filterClassification == 'NON_MINYAN'}">Non-Minyan</option>
                                            <option value="OTHER" th:selected="${filterClassification == 'OTHER'}">Other</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Enabled Filter -->
                                    <div class="filter-group">
                                        <label for="filterEnabled">Status</label>
                                        <select class="form-control" id="filterEnabled" name="filterEnabled">
                                            <option value="">All</option>
                                            <option value="true" th:selected="${filterEnabled == 'true'}">Enabled Only</option>
                                            <option value="false" th:selected="${filterEnabled == 'false'}">Disabled Only</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Date Range -->
                                    <div class="filter-group">
                                        <label for="startDate">Start Date</label>
                                        <input type="date" class="form-control" id="startDate" name="startDate" th:value="${startDate}">
                                    </div>
                                    
                                    <div class="filter-group">
                                        <label for="endDate">End Date</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate" th:value="${endDate}">
                                    </div>
                                    
                                    <!-- Show Non-Minyan Toggle -->
                                    <div class="filter-group" style="min-width: auto;">
                                        <label for="showNonMinyan">Non-Minyan</label>
                                        <div class="form-check" style="padding-top: 0.375rem;">
                                            <input class="form-check-input" type="checkbox" id="showNonMinyan" 
                                                   name="showNonMinyan" value="true" th:checked="${showNonMinyan}">
                                            <label class="form-check-label" for="showNonMinyan">
                                                Show
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="filter-group" style="min-width: auto;">
                                        <label>&nbsp;</label>
                                        <div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search"></i> Apply
                                            </button>
                                            <a th:href="@{/admin/{orgId}/calendar-entries(orgId=${organization.id})}" 
                                               class="btn btn-secondary">
                                                <i class="fas fa-times"></i> Clear
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hidden sort fields -->
                                <input type="hidden" name="sortBy" th:value="${sortBy}">
                                <input type="hidden" name="sortDir" th:value="${sortDir}">
                            </form>
                        </div>
                    </div>

                    <!-- Entries Table -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar"></i> Entries
                                <small class="text-muted" id="entry-count">([[${filteredCount}]] entries)</small>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- Tabulator Table Container -->
                            <div id="calendar-entries-table"></div>
                            
                            <!-- Hidden data for JavaScript -->
                            <script th:inline="javascript">
                                /*<![CDATA[*/
                                window.calendarEntriesData = {
                                    orgId: /*[[${organization.id}]]*/ '',
                                    entries: /*[[${entries}]]*/ [],
                                    locations: /*[[${locations}]]*/ [],
                                    totalEntries: /*[[${totalEntries}]]*/ 0,
                                    filteredCount: /*[[${filteredCount}]]*/ 0
                                };
                                /*]]>*/
                            </script>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (needed by some admin components) -->
<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>

<!-- Tabulator JS -->
<!-- Note: For production, consider hosting Tabulator locally or using SRI hashes for CDN resources -->
<script src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>

<!-- Tabulator Initialization Script -->
<script th:src="@{/admin/calendar-entries-tabulator.js}"></script>

</body>
</html>
