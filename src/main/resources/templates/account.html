<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{admin/layout}">
<head>
    <title layout:fragment="title" th:text="|${queriedaccount.username} - Account|">Account</title>
    
    <th:block layout:fragment="styles">
        <style>
            .account-form-section {
                background: var(--bg-surface, #ffffff);
                border-radius: var(--radius-lg, 0.5rem);
                padding: var(--space-6, 1.5rem);
                margin-bottom: var(--space-4, 1rem);
                box-shadow: var(--shadow-sm, 0 1px 3px rgba(0,0,0,0.1));
            }
            
            .account-action-card {
                background: var(--bg-surface, #ffffff);
                border-radius: var(--radius-lg, 0.5rem);
                padding: var(--space-4, 1rem);
                margin-bottom: var(--space-4, 1rem);
                box-shadow: var(--shadow-sm, 0 1px 3px rgba(0,0,0,0.1));
            }
            
            .account-action-card.warning {
                border-left: 4px solid var(--color-warning, #ffc107);
            }
            
            .account-action-card.danger {
                border-left: 4px solid var(--color-danger, #dc3545);
            }
            
            .sidebar-card {
                background: var(--bg-surface, #ffffff);
                border-radius: var(--radius-lg, 0.5rem);
                padding: var(--space-4, 1rem);
                margin-bottom: var(--space-4, 1rem);
                box-shadow: var(--shadow-sm, 0 1px 3px rgba(0,0,0,0.1));
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <div class="d-flex align-items-center flex-wrap">
                    <h1 class="page-title mr-2" th:text="${queriedaccount.username}">Account Username</h1>
                    <span class="badge" th:classappend="${queriedaccount.isEnabled()} ? ' badge-success' : ' badge-secondary'"
                          th:text="${queriedaccount.isEnabled()} ? 'Enabled' : 'Disabled'">Enabled</span>
                </div>
                <p class="page-description">Edit account profile and settings.</p>
            </div>
        </div>

        <!-- Success Message -->
        <div th:if="${successMessage}" class="alert-modern alert-success mb-4" th:text="${successMessage}"></div>
        <div th:if="${mainErrorMessage}" class="alert-modern alert-danger mb-4" th:text="${mainErrorMessage}"></div>

        <div class="row">
            <div class="col-lg-8 col-md-7">
                <!-- Account Information Form -->
                <div class="account-form-section">
                    <h3 class="mb-4" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold);">Account Information</h3>
                    <form th:action="@{/admin/update-account}" method="post">
                        <input type="hidden" name="id" th:value="${queriedaccount.id}">
                        
                        <div class="form-group mb-4">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" id="username" 
                                   th:value="${queriedaccount.username}" required>
                            <small class="form-text text-muted">This is used for account sign-in.</small>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="email" 
                                   th:value="${queriedaccount.email}" required>
                            <small class="form-text text-muted">This email will be used for password recovery.</small>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label class="form-label">Password</label>
                            <div>
                                <button type="button" class="btn-modern btn-secondary" 
                                        data-toggle="modal" data-target="#change-password-modal">
                                    Change Password
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group mb-4" th:if="${user.isAdmin() && !queriedaccount.isSuperAdmin()}">
                            <label class="form-label">Privileges</label>
                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                <label th:class="${'btn btn-outline-primary' + (queriedaccount.isAdmin() ? ' active' : '')}">
                                    <input type="radio" name="privileges" value="1" th:checked="${queriedaccount.isAdmin()}"> Manager
                                </label>
                                <label th:class="${'btn btn-outline-primary' + ((queriedaccount.isUser() && !queriedaccount.isAdmin()) ? ' active' : '')}">
                                    <input type="radio" name="privileges" value="2" th:checked="${queriedaccount.isUser() && !queriedaccount.isAdmin()}"> User
                                </label>
                            </div>
                            <small class="form-text text-muted">Manager permissions allow the user to add and edit other accounts.</small>
                        </div>
                        
                        <!-- Hidden privileges field for non-admin users -->
                        <div class="form-group" hidden th:if="${!(user.isAdmin() && !queriedaccount.isSuperAdmin())}">
                            <input type="radio" name="privileges" value="1" th:checked="${queriedaccount.isAdmin()}">
                            <input type="radio" name="privileges" value="2" th:checked="${queriedaccount.isUser() && !queriedaccount.isAdmin()}">
                        </div>
                        
                        <div th:if="${updateError}" class="alert-modern alert-danger mb-3" th:text="${updateError}"></div>
                        
                        <button type="submit" class="btn-modern btn-primary">
                            <i class="fas fa-save"></i>
                            Update Account
                        </button>
                    </form>
                </div>

                <!-- Account Actions -->
                <div class="row mt-4" th:if="${user.isAdmin()}">
                    <div class="col-sm-6">
                        <div class="account-action-card warning">
                            <h5 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Account status</h5>
                            <div th:if="${queriedaccount.isEnabled()}">
                                <p class="text-muted mb-3" th:text="|Disable login access to ${siteName ?: 'Minyan Manager'} from this account. This will not erase any of its data.|">
                                    Disable login access. This will not erase any data.
                                </p>
                                <button class="btn-modern btn-warning" data-toggle="modal" data-target="#disable-account-modal">
                                    <i class="fas fa-ban"></i>
                                    Disable Account
                                </button>
                            </div>
                            <div th:if="${queriedaccount.isDisabled()}">
                                <p class="text-muted mb-3">This account is disabled. Enable it to restore access.</p>
                                <button class="btn-modern btn-success" data-toggle="modal" data-target="#enable-account-modal">
                                    <i class="fas fa-check"></i>
                                    Enable Account
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6" th:if="${user.isSuperAdmin()}" sec:authorize="hasRole('ROLE_ADMIN')">
                        <div class="account-action-card danger">
                            <h5 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Delete this account</h5>
                            <p class="text-muted mb-3">Permanently delete all data for this account.</p>
                            <span th:attr="data-toggle=${queriedaccount.isEnabled()} ? 'tooltip' : null, title=${queriedaccount.isEnabled()} ? 'Disable the account before deleting' : null">
                                <button class="btn-modern btn-danger"
                                        th:classappend="${queriedaccount.isEnabled()} ? ' disabled' : ''"
                                        th:attr="data-toggle=${queriedaccount.isEnabled()} ? '' : 'modal', data-target=${queriedaccount.isEnabled()} ? '' : '#delete-account-modal'"
                                        th:disabled="${queriedaccount.isEnabled()}">
                                    <i class="fas fa-trash"></i>
                                    Delete Account
                                </button>
                            </span>
                            <small class="text-muted d-block mt-2" th:if="${queriedaccount.isEnabled()}">Disable this account before deleting.</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-5">
                <!-- Associated Organization Card -->
                 <!-- @TODO: if associated org is not null -->
                <div class="sidebar-card" th:if="${associatedorganization}"> 
                    <h5 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">Associated Organization</h5>
                    <p class="text-muted mb-3" th:text="|View and manage the organization details for ${associatedorganization.name}.|">
                        View and manage organization details.
                    </p>
                    <a th:href="@{/admin/organization(id=${associatedorganization.id})}" class="btn-modern btn-primary">
                        <i class="fas fa-building"></i>
                        Go to Organization
                    </a>
                </div>
                
                <!-- Organizations Link (Super Admin Only) -->
                <div class="sidebar-card" th:if="${user.isSuperAdmin()}" sec:authorize="hasRole('ROLE_ADMIN')">
                    <h5 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">Organizations</h5>
                    <p class="text-muted mb-3">See a list of all organizations and manage their data and details.</p>
                    <a href="/admin/organizations" class="btn-modern btn-primary">
                        <i class="fas fa-building"></i>
                        View All Organizations
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <th:block layout:fragment="modals">
        <!-- Delete Account Modal -->
        <div th:if="${user.isAdmin()}" sec:authorize="hasRole('ROLE_ADMIN')">
            <div class="modal fade" id="delete-account-modal" tabindex="-1" aria-labelledby="delete-account-modal-label" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="delete-account-modal-label" th:text="|Permanently delete '${queriedaccount.username}'?|">Delete Account?</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            Do you want to permanently delete this account? This action cannot be undone.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                            <form th:action="@{/admin/delete-account}" method="post" class="mb-0 d-inline">
                                <input type="hidden" name="id" th:value="${queriedaccount.id}">
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disable Account Modal -->
        <div class="modal fade" id="disable-account-modal" tabindex="-1" aria-labelledby="disable-account-modal-label" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="disable-account-modal-label" th:text="|Disable '${queriedaccount.username}'?|">Disable Account?</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Do you want to disable this account from login access? This action cannot be easily undone.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                        <form th:action="@{/admin/account/disable}" method="post" class="mb-0 d-inline">
                            <input type="hidden" name="id" th:value="${queriedaccount.id}">
                            <button type="submit" class="btn btn-warning">Disable</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enable Account Modal -->
        <div class="modal fade" id="enable-account-modal" tabindex="-1" aria-labelledby="enable-account-modal-label" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="enable-account-modal-label" th:text="|Enable '${queriedaccount.username}'?|">Enable Account?</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Do you want to re-enable this account for login access?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                        <form th:action="@{/admin/account/enable}" method="post" class="mb-0 d-inline">
                            <input type="hidden" name="id" th:value="${queriedaccount.id}">
                            <button type="submit" class="btn btn-success">Enable</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div class="modal fade" id="change-password-modal" tabindex="-1" aria-labelledby="change-password-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="change-password-modal-label">Change Password</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form method="post" th:action="|/admin/accounts/${queriedaccount.id}/changepassword|">
                            <div class="form-group mb-4">
                                <label for="new-password" class="form-label">Password</label>
                                <input type="password" class="form-control" name="password" id="new-password" required>
                            </div>
                            <div class="form-group mb-4">
                                <label for="new-cpassword" class="form-label">Confirm Password</label>
                                <input type="password" class="form-control" name="cpassword" id="new-cpassword" required>
                            </div>

                            <div th:if="${changePasswordError}" class="alert-modern alert-danger mb-3" th:text="${changePasswordError}"></div>

                            <hr>
                            <button type="submit" class="btn-modern btn-primary">
                                <i class="fas fa-key"></i>
                                Update Password
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <!-- Page-specific scripts -->
    <th:block layout:fragment="scripts">
        <script th:src="@{/account.js}"></script>
        <script th:if="${changePasswordError}" th:inline="javascript">
            $(document).ready(function() {
                $('#change-password-modal').modal('show');
            });
        </script>
    </th:block>
</body>
</html>